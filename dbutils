#!/usr/bin/env bash

user="postgres"
#dbhost="162.222.177.187"
dbname="pathfinderdb"
dbhost="localhost"
#user="pathfinderwebserver"


if [ $# -ne 1 ]
then echo "usage: dbutils [restore|save]"; exit
fi

if [ $1 == "save" ]
then
	pg_dump -a -h $dbhost -d $dbname -U $user >> ./restore.sql
	echo "Database Saved"
	exit
fi

if [ $1 != "restore" ]
then echo "usage: dbutils [restore|save]"; exit
fi

IFS='%'

sql=`cat ./1.sql`
regex='
# --- !Ups

(.*)
# --- !Downs
(.*)$'

[[ $sql =~ $regex ]]
up="${BASH_REMATCH[1]}"
restore=`cat ./restore.sql`
down="${BASH_REMATCH[2]}"
restoreText="${down}
${up}
${restore}"
echo $restoreText > query.sql
psql -h $dbhost -d $dbname -U $user -f query.sql
unset IFS
echo "completed"

